{% extends "base.html" %}
{% block title %}Dashboard - Log Analyzer{% endblock %}
{% block content %}
<hgroup>
    <h1>Dashboard</h1>
    <p>{{ file_count }} file(s) analyzed &middot; {{ error_count }} unparsed lines</p>
</hgroup>

<div class="kpi-grid">
    <article class="kpi-card">
        <h2>{{ s.total_requests }}</h2>
        <p>Total Requests</p>
    </article>
    <article class="kpi-card">
        <h2>{{ s.unique_urls }}</h2>
        <p>Unique URLs</p>
    </article>
    <article class="kpi-card">
        <h2>{{ s.unique_ips }}</h2>
        <p>Unique IPs</p>
    </article>
    <article class="kpi-card">
        <h2>{{ s.bot_requests }}</h2>
        <p>Bot Requests</p>
    </article>
    <article class="kpi-card">
        <h2>{{ s.human_requests }}</h2>
        <p>Human Requests</p>
    </article>
    <article class="kpi-card">
        <h2>{{ s.unique_bots }}</h2>
        <p>Unique Bots</p>
    </article>
</div>

<a href="{{ url_for('download_report', report='raw') }}" role="button" class="download-btn outline">Download Raw CSV</a>

{% if s.hits_per_day %}
<h2>Hits per Day</h2>
<div class="bar-chart">
    {% set max_hits = s.hits_per_day | map(attribute='hits') | max %}
    {% for day in s.hits_per_day %}
    <div class="bar"
         style="height: {{ (day.hits / max_hits * 100) | round }}%"
         data-tooltip="{{ day.date }}: {{ day.hits }}">
    </div>
    {% endfor %}
</div>
{% endif %}

<div class="grid">
    <div>
        <h2>Status Codes</h2>
        <table>
            <thead><tr><th>Code</th><th>Count</th><th>%</th></tr></thead>
            <tbody>
            {% for row in s.status_distribution %}
            <tr><td>{{ row.code }}</td><td>{{ row.count }}</td>
                <td>{{ (row.count / s.total_requests * 100) | round(1) }}%</td></tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    <div>
        <h2>Top 10 URLs</h2>
        <table>
            <thead><tr><th>URL</th><th>Hits</th></tr></thead>
            <tbody>
            {% for row in s.top_urls %}
            <tr><td>{{ row.url }}</td><td>{{ row.hits }}</td></tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<h2>Top 10 Bots</h2>
<table>
    <thead><tr><th>Bot</th><th>Hits</th></tr></thead>
    <tbody>
    {% for row in s.top_bots %}
    <tr><td>{{ row.bot_name }}</td><td>{{ row.hits }}</td></tr>
    {% endfor %}
    </tbody>
</table>
{% endblock %}
