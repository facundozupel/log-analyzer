{% extends "base.html" %}
{% block title %}URLs - Log Analyzer{% endblock %}
{% block content %}
<h1>URLs Report</h1>
<p>{{ data | length }} URLs total. Click any row to expand bot details.</p>

<div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
    <a href="{{ url_for('download_report', report='urls') }}" role="button" class="download-btn outline" style="margin-bottom: 0;">Download CSV</a>

    <details class="bot-filter-dropdown" id="botFilterDropdown">
        <summary role="button" class="outline" style="margin-bottom: 0; width: auto;">Filter by Bot</summary>
        <div class="bot-filter-panel">
            <label class="bot-filter-option">
                <input type="checkbox" id="filterSelectAll" checked onchange="toggleAllBots(this.checked)">
                <strong>Select All</strong>
            </label>
            <hr style="margin: 0.25rem 0;">
            {% for bot in all_bots %}
            <label class="bot-filter-option">
                <input type="checkbox" class="bot-checkbox" value="{{ bot }}" checked onchange="applyBotFilter()">
                {{ bot }}
            </label>
            {% endfor %}
        </div>
    </details>
    <span id="filterStatus" style="color: var(--pico-muted-color); font-size: 0.85rem;"></span>
</div>

<table>
    <thead>
        <tr>
            <th>URL</th><th>Hits</th><th>Bot</th><th>Human</th>
            <th>Bots Found</th><th>Status Codes</th><th>Avg Bytes</th><th>Last Access</th>
        </tr>
    </thead>
    <tbody id="urlTableBody">
    {% for row in data %}
    <tr class="url-row" onclick="toggleDetail('detail-{{ loop.index }}', this)" style="cursor: pointer"
        data-bots="{{ row.bots | map(attribute='bot_name') | list | join(',') }}">
        <td><code>{{ row.url }}</code></td>
        <td>{{ row.hits }}</td>
        <td>{{ row.bot_hits }}</td>
        <td>{{ row.human_hits }}</td>
        <td>{{ row.bot_count }}</td>
        <td>{{ row.status_codes }}</td>
        <td>{{ row.avg_bytes }}</td>
        <td>{{ row.last_access }}</td>
    </tr>
    <tr id="detail-{{ loop.index }}" class="bot-detail-row" style="display: none">
        <td colspan="8">
            {% if row.bots %}
            <table class="bot-subtable">
                <thead>
                    <tr>
                        <th>Bot</th><th>Category</th><th>Hits</th>
                        <th>Status Codes</th><th>Avg Bytes</th>
                        <th>First Seen</th><th>Last Seen</th><th>Verified</th>
                    </tr>
                </thead>
                <tbody>
                {% for bot in row.bots %}
                <tr>
                    <td>{{ bot.bot_name }}</td>
                    <td>{{ bot.bot_category }}</td>
                    <td>{{ bot.hits }}</td>
                    <td>{{ bot.status_codes }}</td>
                    <td>{{ bot.avg_bytes }}</td>
                    <td>{{ bot.first_seen }}</td>
                    <td>{{ bot.last_seen }}</td>
                    <td>{% if bot.verified_googlebot %}<span class="verified-badge">Yes</span>{% else %}-{% endif %}</td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
            {% else %}
            <em>No bots detected for this URL.</em>
            {% endif %}
        </td>
    </tr>
    {% endfor %}
    </tbody>
</table>

<script>
function toggleDetail(id, row) {
    var detail = document.getElementById(id);
    if (detail.style.display === 'none') {
        detail.style.display = '';
        row.classList.add('expanded');
    } else {
        detail.style.display = 'none';
        row.classList.remove('expanded');
    }
}

function getSelectedBots() {
    var checkboxes = document.querySelectorAll('.bot-checkbox');
    var selected = [];
    checkboxes.forEach(function(cb) {
        if (cb.checked) selected.push(cb.value);
    });
    return selected;
}

function toggleAllBots(checked) {
    document.querySelectorAll('.bot-checkbox').forEach(function(cb) {
        cb.checked = checked;
    });
    applyBotFilter();
}

function applyBotFilter() {
    var selected = getSelectedBots();
    var allCheckboxes = document.querySelectorAll('.bot-checkbox');
    var selectAllCb = document.getElementById('filterSelectAll');
    selectAllCb.checked = selected.length === allCheckboxes.length;

    var rows = document.querySelectorAll('.url-row');
    var shown = 0;
    rows.forEach(function(row) {
        var detailRow = row.nextElementSibling;
        var rowBots = row.getAttribute('data-bots');
        var botList = rowBots ? rowBots.split(',') : [];

        // Show row if it has no bots (human-only) or has at least one selected bot
        var visible = botList.length === 0 || botList.some(function(b) {
            return selected.indexOf(b) !== -1;
        });

        row.style.display = visible ? '' : 'none';
        if (!visible) {
            detailRow.style.display = 'none';
            row.classList.remove('expanded');
        }
        if (visible) shown++;
    });

    var status = document.getElementById('filterStatus');
    if (selected.length === allCheckboxes.length) {
        status.textContent = '';
    } else {
        status.textContent = 'Showing ' + shown + ' of ' + rows.length + ' URLs';
    }
}
</script>
{% endblock %}
